/**
 * @class       : sse
 * @author      : alex (alex@mac.local)
 * @created     : Miercuri Noi 08, 2023 08:28:25 EET
 * @description : sse
 */

app.post('/completion', (req, res) => {
  res.setHeader('Cache-Control', 'no-cache')
res.setHeader('Content-Type', 'text/event-stream')
res.setHeader('Access-Control-Allow-Origin', '*')
res.setHeader('Connection', 'keep-alive')
res.flushHeaders()  // flush the headers to establish SSE with client

const response = openai.createCompletion(
    {
      model: 'text-davinci-003',
      prompt: 'hello world',
      max_tokens: 100,
      temperature: 0,
      stream: true
    },
    {responseType: 'stream'})

  response.then(resp => {
    resp.data.on('data', data => {
  const lines = data.toString().split('\n').filter(line => line.trim() !== '')
  for (const line of lines) {
    const message = line.replace(/^data: /, '')
    if (message === '[DONE]') {
      res.write('data: DONE\n\n')
      res.end()
      return
    }
    const parsed = JSON.parse(message)
    res.write(`data: ${parsed.choices[0].text}\n\n`)
  }
    })
  }).catch(err => {
    console.log(err)
  })
})

